# RDB the right way

DBの寿命はアプリより長い

users、ブックマークもダイヤリーも同じテーブルを見る

## The Rigth Way

正しい設計とは？

### 論理設計

ER図を考える
↓
モデリングする

「必ず知るべきこと」にフォーカス

データと情報は違う
SQLアンチパターン
「さて、皆さんは「情報」と「データ」の違いをご存知でしょうか。
この二者の関係は「多くの情報を秘めた貴重なデータ」という表現で言い尽くせます。
いつでも我々が欲しいのは、意味のある(目的を持った)正しい情報なのです。
一方、データは単なる各種の事実の値(何らかの、名称とか日付とか金額とか)であって
それ自体に目的はありません。」

データ(事実)と情報(見たい内容)

データ設計と情報設計は分けることが大事

- データ設計
  - どのように事実を保存するか
- 情報設計
  - 事実を如何に加工・利用するか

情報優先でデータ設計をするとデータに矛盾が生まれる
- アプリケーションのバグなどによる

どう設計するか？

ER図を書く
Entityを定義する
イベント(コト)とリソース(モノ)

イベントとは
- 事実、つまり過去しかない
- 定期的に繰り返される
- 5W2Hで考えると良い

リソースとは
- 事実を生み出すもの
- 未来も定義できる
- 概念も定義できる
- WhenとHow to以外

Entityを関連付ける
Relationship

#### まず現実をモデリングする
- Users
  - 一般ユーザも権限もadminも全部ユーザ
    - if文で見る つらい

#### リレーショナルモデルで定義する

正規化

- データに矛盾がある
  - 関連従属が自明ではない
  - 正規化できていない

これをなくしていく

#### 理論を正しく理解してRDBを使いこなす

事実を正しく保存して正しいデータを作る

達人に学ぶDB設計

### 物理設計

正規化した結果で問題がない場合
- データ設計もほぼ完成している
  - INDEXとの相談
    - Indexが5こひつようというのは責務が大きすぎる、モデリングが正しく無さそう
  
正規化だけで解決しない問題
- パフォーマンス問題
  - JOINが多段
  - 条件多い
  - 書き込み・更新が多い
  - INDEXがきかない
- アプリケーションの制約
  - ID必須
  - 外部キー制約未対応
- システムアーキテクチャの制約
  - データストアが複数
  - セキュリティ制約
  - マイクロサービス化

#### パフォーマンスで困る時

RDBMSの機能を正しく使う
- 制約を使ってデータを担保する
- 特殊なINDEXを使って複雑なクエリを対処する
- 拡張機能を利用して特別なケースに対応する

##### 制約を使ってデータを担保する

```CREATE TABLE enquete ("その他" text CHECK("好きなDB" = "その他"), …)``` CHECK制約
(mysqlにはない)
CHECK制約または第5正規化まで

##### 特殊なINDEXを使って複雑なクエリを対処する

- 式INDEX
  - 関数の結果をindexできる
- 列指向INDEX
- フルテキスト INDEX
- GIN INDEX

など

##### 拡張機能を利用して特別なケースに対応する

- DBlinkやFDWで外のDB(NoSQLを含む)を参照する
- パーテーションでテーブルを分割する
- マテリアライズド・ビューで集計結果をキャシュする

##### データは常に成長する

今日が正しかったことが来年は正しいとは限らない

5年後、システム負荷でDBがボトルネックに
- 困ったときに上記の対応をする
  - 奥の手とする
量は増え、質は変化する

##### なので

正しさを常に問う
正しい設計は常に変化する

#### 本

データベース実践入門

#### DBの問題は忘れた頃にやってくる

DBの問題は忘れた頃にやってくる

## 壮大なるリファクタリング

### 変化するデータベースに対応している

#### データベースの不吉な匂い

技術的負債
- チーズ
  - 価値がある、すぐすてなくてもいい
- 腐った牛乳
  - すぐ治さなければいけない


去年の資料をみるといい

#### スーパーテーブルつくってないか

テーブルの責務

クラスの責務ににてる
- 行毎に複数の状態を持っている
  - delete_flag
- 値によって意味が変わる
  - 末尾9だと~~
- 特定の列の値で他の列の値の意味が変わる
  - config
    - name:value
    - maxlimit:int
    - apiurl:string
  - EAVというアンチパターン
- 一つのテーブルが色んな用途で使われる
  - B to CのサービスでUserテーブルに会員と管理者が混在するなど

SQLアンチパターンを読んでください

### トリガーで分けるというリファクタ

REFACTORING DATABASE

アプリケーションで直せるのであればそっちでやったほうがいい
- テストが書きやすいので

複数アプリで1つのDBをやりとりする場合等はトリガーが良さそう

### 担当のデータベーステーブルを全て把握してますか？

#### データベース考古学

現状をまず把握する
↓
以下をもとに正しい姿の設計をする

現在地とゴールまでの距離を測る
あとは少しづつ改善していく
- 壊しても戻せる範囲
  - ALTERできるかどうかなど

##### TABLE一覧を眺める会

- チーム全員でやる
- 知らなかった情報の共有

##### batchから読み解く

どうやって使われてるか

## まとめ

### データベースの寿命はアプリケーションよりも長い

ちゃんとやってれば我々を助けてくれる

情報はデータがないと作れない
データが消えると取り戻せない

### 解決した問題の大きさがエンジニアの価値

#### 覚悟を決めるには根拠が必要

根拠は技術で解決できる

数冊の本を読むだけで充分な知識がつくのがRDB

これで10年戦える

### RDB THE Right Way

あなたの道を歩くのはあなた自身

# Q&A

- Q. ER図以外でやっているけどどうなの
  - A. 良いと思う
    - ER図にもいろいろな種類がある
    - ホワイトボードに書いたり
