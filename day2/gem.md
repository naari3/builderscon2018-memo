# すべてがgemになる

https://t.co/TZvRM6ZHpq

今のニュースとそっくり

質問したいこと
- routesはどう管理しているか

## 概要

既存サービスと連携したい
開発スピードが生命線

数年後にもなんとかなる設計,方法

## だれ

@izumin5210

### wantedly people

サービスが密結合っぽい

## wantedlyのサービス3つある

visit chat people

### chat

- メインサーバ
  - メインの機能、ドメイン
- ユーザ認証
  - 全サービス共通で利用する認証サーバ

### people

- マイクロサービス
  - rubyが得意じゃないタスクが増えたため
  - kubernetesが本番投入！

#### マザーrails

- 最初にコアなRailsのなんでもやるアプリを作る
  - こいつにプロトタイプを作った後golangとかでマイクロサービスにしたりする

### じつは

chatとpeopleのメインrails鯖は同じ
turai 密結合

#### 密結合の何が辛いか

- いいところ
  - 既存の資産を活かすことができる
    - 便利APIをどんどん使うことができる
    - モデルも共有できる
  - サーバーがいっぱいあるとつらい
    - エラーハンドリング、リトライ
- だめなところ
  - 障害が起きたりすると大変
    - どっちが原因で問題がおきたかわからんくなる
  - モデルが混ざる
    - app/models どれがどっちのサービスなのかわからん
      - ネームスペースで解決？
    - chatが生まれたときはchatしかない、ネームスペースはついてない
      - 歴史的経緯から

## つらいので密結合と立ち向かう

3回トライをして1回大失敗した

1. 関連エンドポイントを全部上げる大会
  - 何が chat に依存しているかを洗い出すため
    - APIだけでなく、内部依存レベルで依存していたり
      - ユーザ情報取得 テーブル共有してる etc
  - モデルを明らかにする
    - どのモデルがどんな技術に依存しているのかを明らかにする
2. ドメイン定義 & 移行先サーバ作り
  - そもそもドメインモデルが把握できてないので理解
  - 新しい機能を書くためのrailsも用意
  - モデル共有したい、しかし2機のアプリに同じものを書くのはつらい
    - gemを使えばいいのでは
3. モデルのshared gem化

## モデルのshared gem化

1. とりあえずDB共有
  - マイクロサービスではアンチパターンと言われる
  - ARに限ってのみOKとした
2. 切り出し対象を決める
  - 関連するモデルやサービスの依存関係を洗い出す
    - コードの静的解析等
3. 切り出す、gemにする
  - peopleドメインに関するものをgemに移す
  - people chat両方のドメインにまたがる場合もgemに移す
  - chatのみはrailsに残したまま

- 副作用を伴うライフサイクルコールバックはどうするか
  - callback

## まとめ

サービス密結合で後悔しないために
- 後から作ったサービスに関するコードはネームスペースをつけよう
- 同じテーブルをサービス間で共有するのはよくなかった？
- 最初からDBわければよかった
- コアの価値を提供する部分はテストを書くべきだった
  - ただ、事象を

分割するときは
- ドメインと実装を見極めよう
  - どっちのサービスがどっちの実装を持っているのか、依存しているのか
  - ドメインが安定してから切り出す、速すぎると良くない判断になるかも
    - 安定したサービスから切り出す
